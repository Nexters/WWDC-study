# [WWDC 2022] Explore structured concurrency in Swift

> ì˜ìƒ 1ì¤„ ìš”ì•½: Structured Concurrencyë¥¼ Swiftì—ì„œ ì§€ì›í•œë‹¤.
> 

## ì‹œì‘ì— ì•ì„œâ€¦

---

ì‹œì‘ì— ì•ì„œì„œ ì•Œì•„ë‘ì–´ì•¼ í•  ìš©ì–´ë“¤ì´ ìˆìŠµë‹ˆë‹¤!

- í”íˆ ì• í”Œ ê³µì‹ë¬¸ì„œë¥¼ ì½ë‹¤ë³´ë©´, â€œìƒˆë¡œìš´ ì‹¤í–‰ contextê°€ ìƒì„±ëœë‹¤.â€ ë¼ëŠ” ë§ì´ ë°˜ë³µë˜ëŠ”ë°.
- â€˜ì‹¤í–‰ contextâ€™ê°€ ë¬´ì—‡ì´ê¸¸ë˜ ê°•ì¡°í•´ì„œ ë§í•˜ëŠ” ê²ƒì¼ê¹Œìš”?
- ì¼ë°˜ì ìœ¼ë¡œ í”„ë¡œê·¸ë¨ì€ ìœ„ì—ì„œ ì•„ë˜ë¡œ, top-down ë°©ì‹ìœ¼ë¡œ ì‹¤í–‰ë©ë‹ˆë‹¤.

![Untitled](%5BWWDC%202022%5D%20Explore%20structured%20concurrency%20in%20Swif%20272879ee2f8a4529b1d34ddd132b2bb0/Untitled.png)

- ê·¸ë˜ì„œ ìœ„ ì½”ë“œëŠ” print(A) â†’ print(B) â†’ print(C) ìˆœìœ¼ë¡œ ì‹¤í–‰ë˜ì£ .
- í•˜ì§€ë§Œ ë§Œì¼ print(B)ë¥¼ ë‹¤ìŒê³¼ ê°™ì´ `Global Queue` ì—ì„œ ì‹¤í–‰ë˜ë„ë¡ í•œë‹¤ë©´ ì–´ë–»ê²Œ ë ê¹Œìš”?

![Untitled](%5BWWDC%202022%5D%20Explore%20structured%20concurrency%20in%20Swif%20272879ee2f8a4529b1d34ddd132b2bb0/Untitled%201.png)

- ì½”ë“œë¥¼ ì‹¤í–‰í•˜ëŠ” íë¦„ì´ `print(A) â†’ print(C)` ë¥¼ ì‹¤í–‰í•˜ëŠ” íë¦„ê³¼ `print(B)`ë¥¼ ì‹¤í–‰í•˜ëŠ” íë¦„ìœ¼ë¡œ ë¶„ë¦¬ë˜ê³ , ë‘ ì‹¤í–‰íë¦„ì€ ë™ì‹œì— ì‹¤í–‰ë©ë‹ˆë‹¤.
- ì´ë ‡ë“¯, ì½”ë“œë¥¼ ì‹¤í–‰í•˜ëŠ” ìƒˆë¡œìš´ íë¦„ì´ ìƒê²¼ì„ ë•Œ, â€œìƒˆë¡œìš´ ì‹¤í–‰ context ê°€ ìƒê²¼ë‹¤â€ ë¼ê³  í‘œí˜„í•©ë‹ˆë‹¤.

- `scope` : ë³€ìˆ˜ê°€ ìƒì„±ëœ ì¤‘ê´„í˜¸(`{}`) ë²”ìœ„

```swift
func anyfunction() {
	let value = "value"
}
```

- ë³€ìˆ˜ `value`ì˜ scopeëŠ” `anyfunction()`ì…ë‹ˆë‹¤.
= `anyfunction()` ì„ ë„˜ì–´ê°€ë©´ `value`ëŠ” ë©”ëª¨ë¦¬ì—ì„œ í•´ì œë©ë‹ˆë‹¤.

## ì—¬ëŸ¬ ì‘ì—…ì„ ë³‘ë ¬ì ìœ¼ë¡œ ì²˜ë¦¬í•˜ê³  ì‹¶ì„ ë•Œ: `Task` ë¥¼ ì‚¬ìš©í•´ë¼â€¼ï¸

---

1. TaskëŠ” ì½”ë“œë¥¼ ë¹„ë™ê¸°ì ìœ¼ë¡œ ì‹¤í–‰í•  ìˆ˜ ìˆëŠ” contextë¥¼ ë§Œë“¤ì–´ì¤ë‹ˆë‹¤.
(ìƒˆë¡œìš´ Task = ìƒˆë¡œìš´ ì‹¤í–‰ context)
    
    ```swift
    Task {
    	// ë¹„ë™ê¸°ì ìœ¼ë¡œ ì‹¤í–‰í•˜ê³  ì‹¶ì€ ì½”ë“œ
    }
    ```
    
    - `Task` ë¥¼ ìƒì„±í•  ë•Œ, ì¤‘ê´„í˜¸(`{ }`) ì•ˆì— ì‘ì„±í•˜ëŠ” ì½”ë“œëŠ” ë¹„ë™ê¸°ì ìœ¼ë¡œ ì‹¤í–‰ë©ë‹ˆë‹¤.
2. ê° TaskëŠ” ë‹¤ë¥¸ ì‹¤í–‰ contextì™€ ë™ì‹œì— ì‹¤í–‰ë©ë‹ˆë‹¤.
3. ë‚´ë¶€ì—ì„œ `async-await`ë©”ì„œë“œë¥¼ í˜¸ì¶œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
4. SwiftëŠ” ê°œë°œìê°€ ë²„ê·¸ë¥¼ ì¼ìœ¼í‚¬ë§Œí•œ ì½”ë“œë¥¼ ê°€ì§€ê³  Taskë¥¼ ìƒì„±í•˜ëŠ”ì§€ ì²´í¬í•´ì¤ë‹ˆë‹¤.
5. í•˜ì§€ë§Œ async-await ë©”ì„œë“œë¥¼ í˜¸ì¶œí•˜ëŠ” ê²ƒë§Œìœ¼ë¡œëŠ” ìƒˆë¡œìš´ ì‹¤í–‰ contextê°€ ìƒì„±ë˜ì§€ ì•Šìœ¼ë©°, ê¼­ Taskë¥¼ ìƒì„±í•´ì•¼ë§Œ ìƒˆë¡œìš´ ì‹¤í–‰ contextê°€ ìƒì„±ë©ë‹ˆë‹¤.

## Taskì˜ ì¢…ë¥˜

---

Taskì˜ ì¢…ë¥˜ë¡œëŠ” í¬ê²Œ 4ê°€ì§€ê°€ ìˆìŠµë‹ˆë‹¤.

1. structured task
    1. async - let
    2. Task Group
2. Unstructured Task
3. Detached Task

### 1. async-let

![á„‰á…³á„á…³á„…á…µá†«á„‰á…£á†º 2022-07-28 á„‹á…©á„’á…® 5.32.06.jpg](%5BWWDC%202022%5D%20Explore%20structured%20concurrency%20in%20Swif%20272879ee2f8a4529b1d34ddd132b2bb0/%25E1%2584%2589%25E1%2585%25B3%25E1%2584%258F%25E1%2585%25B3%25E1%2584%2585%25E1%2585%25B5%25E1%2586%25AB%25E1%2584%2589%25E1%2585%25A3%25E1%2586%25BA_2022-07-28_%25E1%2584%258B%25E1%2585%25A9%25E1%2584%2592%25E1%2585%25AE_5.32.06.jpg)

- async letì„ ì‚¬ìš©í•˜ëŠ” ë°©ë²•ì€ ë‹¤ìŒê³¼ ê°™ì´ ë³€ìˆ˜ë¥¼ ì„ ì–¸í•  ë•Œ ì•ì— `async` í‚¤ì›Œë“œë¥¼ ë¶™ì´ë©´ ë©ë‹ˆë‹¤.
- í”„ë¡œì„¸ìŠ¤ëŠ” ì½”ë“œë¥¼ ì‹¤í–‰í•˜ë‹¤ê°€ `async-let` êµ¬ë¬¸ì„ ë§Œë‚˜ë©´, ìƒˆë¡œìš´ Taskë¥¼ ìƒì„±í•©ë‹ˆë‹¤. ì´ë¡œ ì¸í•´ ìƒˆë¡œìš´ ì‹¤í–‰ contextê°€ ìƒì„±ë©ë‹ˆë‹¤.
- ë”°ë¼ì„œ `async let` ì½”ë“œë¥¼ ì‹¤í–‰í•œ ì´í›„ì—ëŠ” 2ê°œì˜ ì‹¤í–‰ contextê°€ ì¡´ì¬í•˜ê²Œ ë©ë‹ˆë‹¤.
    - ì²«ë²ˆì§¸ë¡œ, async let ì´ì „ê¹Œì§€ ì½”ë“œë¥¼ ì‹¤í–‰í•˜ë˜ ê¸°ì¡´ì˜ ì‹¤í–‰ contextê°€ ì¡´ì¬í•˜ê³ 
    ë‘ë²ˆì§¸ë¡œ, ê¸°ì¡´ì˜ ì‹¤í–‰ contextê°€ `async let`ì„ ë§Œë‚˜ì„œ ìƒì„±í•˜ëŠ” Task(ìƒˆë¡œìš´ ì‹¤í–‰ context)ê°€ ì¡´ì¬í•©ë‹ˆë‹¤.
- ìƒˆë¡œìš´ ì‹¤í–‰ Context `=` ì˜ ì˜¤ë¥¸ìª½ì— ìœ„ì¹˜í•œ URLSession.shard.data`()` ë¥¼ ì‹¤í–‰í•˜ê³ ,
    
    ê¸°ì¡´ì˜ ì‹¤í–‰ contextëŠ” `async let` ë³€ìˆ˜ì— placeholderê°’ì„ ë‹´ì€ í›„, ì´ì–´ì„œ ë‹¤ìŒ ëª…ë ¹ì–´ë¥¼ ì‹¤í–‰í•©ë‹ˆë‹¤.
    
- ê·¸ëŸ¬ë‹¤ `async let` ë³€ìˆ˜ë¥¼ ì‚¬ìš©í•´ì•¼ í•˜ëŠ” ìœ„ì¹˜ë¥¼ ë§Œë‚˜ë©´, ìƒˆë¡œìš´ ì‹¤í–‰ contextê°€ ì‘ì—…ì„ ì™„ë£Œí•  ë•Œê¹Œì§€ ëŒ€ê¸°í•©ë‹ˆë‹¤.
- ìƒˆë¡œìš´ ì‹¤í–‰ contextëŠ” ì‘ì—…ì„ ëª¨ë‘ ì™„ë£Œí•˜ë©´, ì‘ì—… ê²°ê³¼ë¥¼  async let ë³€ìˆ˜ì— ì €ì¥í•©ë‹ˆë‹¤.
- ê¸°ì¡´ ì‹¤í–‰ contextëŠ” aysnc let ë³€ìˆ˜ê°’ì„ ê°€ì§€ê³  ì‘ì—…ì„ ì²˜ë¦¬í•©ë‹ˆë‹¤.

- ***ê·¸ëŸ°ë°, ìœ„ì—ì„œ `asyc-let` ì½”ë“œë¥¼ ë§Œë‚˜ì„œ ìƒˆë¡œìš´ Taskë¥¼ ìƒì„±í•œ, ê¸°ì¡´ì˜ ì‹¤í–‰ contextë„ í•˜ë‚˜ì˜ `Task` ì…ë‹ˆë‹¤.***
- ì¦‰, ëª¨ë“  ì½”ë“œëŠ” `Task`ì— í¬í•¨ëœ ê²ƒì…ë‹ˆë‹¤.
- ê·¸ë¦¬ê³  `async-let` êµ¬ë¬¸ ì²˜ëŸ¼,  í•œ `Task` ì—ì„œ ìƒˆë¡œìš´ `Task` ë¥¼ ìƒì„±í•˜ë©´, ë‘ `Task` ê°„ì— ë¶€ëª¨ ìì‹ ê´€ê³„ê°€ í˜•ì„±ë©ë‹ˆë‹¤.

- ex)

```swift
class MainViewController: UIViewController {
	override func viewDidLoad() {
		fetchOneThumbnail()
	}
}
```

![á„‰á…³á„á…³á„…á…µá†«á„‰á…£á†º 2022-07-28 á„‹á…©á„’á…® 5.52.25.jpg](%5BWWDC%202022%5D%20Explore%20structured%20concurrency%20in%20Swif%20272879ee2f8a4529b1d34ddd132b2bb0/%25E1%2584%2589%25E1%2585%25B3%25E1%2584%258F%25E1%2585%25B3%25E1%2584%2585%25E1%2585%25B5%25E1%2586%25AB%25E1%2584%2589%25E1%2585%25A3%25E1%2586%25BA_2022-07-28_%25E1%2584%258B%25E1%2585%25A9%25E1%2584%2592%25E1%2585%25AE_5.52.25.jpg)

- ì˜ˆë¥¼ ë“¤ì–´ì„œ ìœ„ ì½”ë“œëŠ” `fetchOneThumbnail()` ì„ ì‹¤í–‰í•˜ëŠ” `MainViewController`  ë¥¼ ë‚˜íƒ€ëƒ…ë‹ˆë‹¤.
- ê·¸ëŸ¼ `MainViewController`ë¥¼ ì‹¤í–‰í–ˆì„ ë•Œ, `fetchOneThumbnail()` ë¥¼ ì‹¤í–‰í•˜ëŠ” `Task`ê°€ ì¡´ì¬í•˜ê²Œ ë©ë‹ˆë‹¤.
- ê·¸ë¦¬ê³  `fetchOneThumbnail()` ì€ 2ê°œì˜ `async-let` êµ¬ë¬¸ì„ ì‹¤í–‰í•˜ì—¬, 2ê°œì˜ `Task`ê°€ ìƒˆë¡œ ìƒì„±ë˜ë©°, 
ì´ `Task`ë“¤ì€ `fetchOneThumbnail()` ì„ ì‹¤í–‰í•œ `Task` ë¥¼ ë¶€ëª¨ë¡œ ê°–ê²Œ ë©ë‹ˆë‹¤.
- ***ì´ì²˜ëŸ¼ ìƒˆë¡­ê²Œ ìƒì„±ëœ  `Structured Task` ëŠ” ê¸°ì¡´ì˜ `Task` ì™€ ë¶€ëª¨-ìì‹ ê´€ê³„ë¡œ ì—°ê²°ë©ë‹ˆë‹¤.***

### Task ê°„ ë¶€ëª¨-ìì‹ ê´€ê³„ì—ì„œ ì›ì¹™ - `Structured Task` íŠ¹ì§•

1. ìì‹ Taskê°€ ëª¨ë‘ ì¢…ë£Œëœ í›„ì—, ë¶€ëª¨ Taskê°€ ì¢…ë£Œë  ìˆ˜ ìˆìŠµë‹ˆë‹¤â€¼ï¸
    
    â†’ ì´ íŠ¹ì§• ë•ë¶„ì—, ì¢…ë£Œë˜ì–´ì•¼ í•˜ëŠ” Taskê°€ ê³„ì†í•´ì„œ ì‹¤í–‰ë˜ëŠ” í˜„ìƒ(Task leaking)ì„ ë°©ì§€í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
    
2. ê·¸ë¦¬ê³  ì´ ì›ì¹™ì€ Task ì‹¤í–‰ ì¤‘ì— ì˜¤ë¥˜ê°€ ë°œìƒí–ˆì„ ë•Œë„ ì§€ì¼œì§‘ë‹ˆë‹¤.
3. ìì‹ TaskëŠ” ë¶€ëª¨ Taskì˜ ì†ì„±(ì–´ë”” ìŠ¤ë ˆë“œì—ì„œ ì‹¤í–‰ë˜ëŠ”ì§€, ì‹¤í–‰ ìš°ì„ ìˆœìœ„ ë“±)ì„ ë¬¼ë ¤ ë°›ìŠµë‹ˆë‹¤.
4. ì—ëŸ¬ê°€ ë°œìƒí•˜ë©´, í˜•ì œ Taskì™€ ë¶€ëª¨ Taskì— ì „íŒŒë©ë‹ˆë‹¤.

- ì˜ˆë¥¼ ë“¤ì–´ì„œ, `metadata` ë¥¼ ë‹¤ìš´ë¡œë“œ ë°›ëŠ” ì‘ì—…ì´ ì‹¤í–‰ì¤‘ì— errorê°€ ë°œìƒí–ˆë‹¤ë©´, `fetchOneThumbnail`ëŠ” ë°œìƒí•œ errorë¥¼ throw í•˜ê³ , í•¨ìˆ˜ ì‹¤í–‰ì„ ì¢…ë£Œí•©ë‹ˆë‹¤.
- ì´ë•Œ ë§Œì¼ `data` ë¥¼ ë‹¤ìš´ë¡œë“œ ë°›ëŠ” Taskê°€ ì•„ì§ ì‹¤í–‰ ì¤‘ì´ë¼ë©´, 
ì´ Taskë¥¼ ë°”ë¡œ ì¤‘ë‹¨ì‹œì¼œ ë²„ë¦¬ëŠ” ê²ƒì´ ì•„ë‹ˆë¼, ì·¨ì†Œë˜ì—ˆë‹¤ê³ (`cancelled` ) í‘œì‹œí•˜ê³  Taskê°€ ì™„ë£Œë  ë•Œê¹Œì§€ ê¸°ë‹¤ë¦½ë‹ˆë‹¤.
- ê·¸ë¦¬ê³  ì·¨ì†Œëœ TaskëŠ” ì‘ì—…ì„ ëê¹Œì§€ ì™„ë£Œí•˜ê³ , ì‘ì—… ê²°ê³¼ë§Œ ì‚¬ìš©í•˜ì§€ ì•Šê³  ë²„ë¦½ë‹ˆë‹¤.

![á„‰á…³á„á…³á„…á…µá†«á„‰á…£á†º 2022-07-28 á„‹á…©á„’á…® 6.08.27.jpg](%5BWWDC%202022%5D%20Explore%20structured%20concurrency%20in%20Swif%20272879ee2f8a4529b1d34ddd132b2bb0/%25E1%2584%2589%25E1%2585%25B3%25E1%2584%258F%25E1%2585%25B3%25E1%2584%2585%25E1%2585%25B5%25E1%2586%25AB%25E1%2584%2589%25E1%2585%25A3%25E1%2586%25BA_2022-07-28_%25E1%2584%258B%25E1%2585%25A9%25E1%2584%2592%25E1%2585%25AE_6.08.27.jpg)

- ë˜í•œ, í•œ `Task` ë¥¼ `cancelled` í‘œì‹œí•˜ë©´, ê·¸ `Task` ì˜ ëª¨ë“  ìì‹ `Task` ë„ `cancelled` í‘œì‹œë˜ì–´ ì¢…ë£Œë©ë‹ˆë‹¤.

![á„‰á…³á„á…³á„…á…µá†«á„‰á…£á†º 2022-07-28 á„‹á…©á„’á…® 6.08.58.jpg](%5BWWDC%202022%5D%20Explore%20structured%20concurrency%20in%20Swif%20272879ee2f8a4529b1d34ddd132b2bb0/%25E1%2584%2589%25E1%2585%25B3%25E1%2584%258F%25E1%2585%25B3%25E1%2584%2585%25E1%2585%25B5%25E1%2586%25AB%25E1%2584%2589%25E1%2585%25A3%25E1%2586%25BA_2022-07-28_%25E1%2584%258B%25E1%2585%25A9%25E1%2584%2592%25E1%2585%25AE_6.08.58.jpg)

- ì´ë ‡ê²Œ í•´ì„œ, `fetchOneThumbnail()` ë©”ì„œë“œëŠ” ëª¨ë“  ìì‹ `Task` ê°€ ì¢…ë£Œëœ í›„ì—ì•¼, error throw í•©ë‹ˆë‹¤.

- ê·¸ë¦¬ê³  TaskëŠ” ë°”ë¡œ ì¢…ë£Œë˜ì§€ ì•Šê¸° ë•Œë¬¸ì—, Taskê°€ ì‹¤í–‰ì¤‘ì¼ ë•Œë§Œ í•´ì•¼ í•˜ëŠ” ì‘ì—…ì´ ìˆë‹¤ë©´, Taskê°€ ì·¨ì†Œë˜ì—ˆëŠ”ì§€ ì²´í¬í•˜ê³  ê·¸ ì‘ì—…ì„ ìˆ˜í–‰í•˜ë„ë¡ ë§Œë“¤ì–´ì•¼ í•©ë‹ˆë‹¤.
- Taskê°€ ì·¨ì†Œë˜ì—ˆëŠ”ì§€ ì²´í¬í•˜ëŠ” ë©”ì„œë“œ
    1. `try Task.checkCancellation`
        - í˜„ì¬ Taskê°€ cancellë¬ìœ¼ë©´ throw error
    2. `Task.isCancelled`
        1. í˜„ì¬ Taskê°€ cancellë¬ìœ¼ë©´ return true

## Task Group

---

![á„‰á…³á„á…³á„…á…µá†«á„‰á…£á†º 2022-07-28 á„‹á…©á„’á…® 7.30.46.jpg](%5BWWDC%202022%5D%20Explore%20structured%20concurrency%20in%20Swif%20272879ee2f8a4529b1d34ddd132b2bb0/%25E1%2584%2589%25E1%2585%25B3%25E1%2584%258F%25E1%2585%25B3%25E1%2584%2585%25E1%2585%25B5%25E1%2586%25AB%25E1%2584%2589%25E1%2585%25A3%25E1%2586%25BA_2022-07-28_%25E1%2584%258B%25E1%2585%25A9%25E1%2584%2592%25E1%2585%25AE_7.30.46.jpg)

- ì´ ì½”ë“œëŠ” `async-let`ì˜ íŠ¹ì„±ìƒ, í•˜ë‚˜ì˜ thumbnail idì— í•´ë‹¹í•˜ëŠ” dataë¥¼ ê°€ì ¸ì˜¤ëŠ” ì‘ì—…ê³¼ metadataë¥¼ ê°€ì ¸ì˜¤ëŠ” ì‘ì—…ë§Œ ë™ì‹œì— ì‹¤í–‰ë©ë‹ˆë‹¤. â†’ í•œë²ˆì— ìì‹ Taskê°€ ìµœëŒ€ 2ê°œê¹Œì§€ë§Œ ìƒì„±ë©ë‹ˆë‹¤.
- ë§Œì¼, ëª¨ë“  thumbnail idì— ëŒ€í•œ `data`ì™€ `metadata`ë¥¼ ë™ì‹œì— ë‹¤ìš´ ì‹¶ë‹¤ë©´, ì´ë•ŒëŠ” `Task Group`ì„ ì‚¬ìš©í•´ì•¼ í•©ë‹ˆë‹¤.

### Task Groupì´ë€?

- ë™ì‹œì— ì‹¤í–‰ë˜ì–´ì•¼ í•˜ëŠ” `Task`ì˜ ê°œìˆ˜ë¥¼ ì •í™•í•˜ê²Œ ëª¨ë¥¼ ë•Œ ì‚¬ìš©
- ìœ„ ì˜ˆì‹œì—ì„œ Task Groupì„ ì‚¬ìš©í•´ì•¼ í•˜ëŠ” ì´ìœ 
    - ìœ„ ì˜ˆì‹œì—ì„œ ëª¨ë“  thumbnail idì— ëŒ€í•´ì„œ dataì™€ metadataë¥¼ ë™ì‹œì— ë‹¤ìš´ ë°›ë„ë¡ í•  ë•Œ, ìƒì„±ë˜ëŠ” ì´ Taskì˜ ê°œìˆ˜ëŠ” `ids` ë°°ì—´ì˜ ê¸¸ì´ì™€ ê°™ìŠµë‹ˆë‹¤.
    - ì´ ë§ì¸ì¦‰ìŠ¨, ì‹¤ì œë¡œ ë©”ì„œë“œ í˜¸ì¶œë˜ì–´ ids íŒŒë¼ë¯¸í„° ê°’ì´ ê²°ì •ë˜ê¸° ì „ê¹Œì§€ëŠ” Taskì˜ ê°œìˆ˜ë¥¼ ì•Œ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.
    â†’ Task Groupì„ ì‚¬ìš©í•´ì•¼ í•©ë‹ˆë‹¤.
- `Task Group`ì„ ì‚¬ìš©í•œ ì½”ë“œ

![á„‰á…³á„á…³á„…á…µá†«á„‰á…£á†º 2022-07-28 á„‹á…©á„’á…® 7.36.04.jpg](%5BWWDC%202022%5D%20Explore%20structured%20concurrency%20in%20Swif%20272879ee2f8a4529b1d34ddd132b2bb0/%25E1%2584%2589%25E1%2585%25B3%25E1%2584%258F%25E1%2585%25B3%25E1%2584%2585%25E1%2585%25B5%25E1%2586%25AB%25E1%2584%2589%25E1%2585%25A3%25E1%2586%25BA_2022-07-28_%25E1%2584%258B%25E1%2585%25A9%25E1%2584%2592%25E1%2585%25AE_7.36.04.jpg)

- `withThrowingTaskGroup(of:)` ë¥¼ ì´ìš©í•˜ì—¬ `Task Group`ì„ ìƒì„±í•©ë‹ˆë‹¤.
    - `withThrowingTaskGroup(of:)` ë‚´ë¶€ì—ì„œ `group.async` ë¥¼ í˜¸ì¶œí•˜ë©´ ìƒˆë¡œìš´ Taskê°€ ìƒì„±ë˜ì–´ groupì— ì¶”ê°€ë˜ë©°, groupì— ì¶”ê°€ëœ TaskëŠ” ë°”ë¡œ ì‹¤í–‰ë©ë‹ˆë‹¤.
    - groupì— ì¶”ê°€ëœ Taskë§ˆë‹¤ `fetchOneThumbnail()`ì„ í˜¸ì¶œí•˜ë©°, 
    `fetchOneThumbnail()`ì€ 2ê°œì˜ task ( `data`ë¥¼ ê°€ì ¸ì˜¤ëŠ” `async-let` Task, `metadata` ë¥¼ ê°€ì ¸ì˜¤ëŠ” `async-let` Task)ë¥¼ ìƒì„±ë©ë‹ˆë‹¤.
    - ***ê²°ê³¼ì ìœ¼ë¡œ (ë°°ì—´  `ids` ê¸¸ì´ *  2)ê°œì˜ taskê°€ ìƒì„±ë˜ì–´, ëª¨ë“  idì— ëŒ€í•œ `data`ì™€ `metadata`ë¥¼ ê°€ì ¸ì˜¤ëŠ” Taskê°€ ë™ì‹œì— ì‹¤í–‰ë©ë‹ˆë‹¤.***
- ê·¸ë¦¬ê³  groupì˜ ëª¨ë“  `Task`ê°€ ì‹¤í–‰ì™„ë£Œ ëœ í›„ì—ì•¼   `withThrowingTaskGroup(of:)` ì˜ ë‹¤ìŒ ëª…ë ¹ì–´(ì—¬ê¸°ì„œëŠ” `return thumbnails`)ê°€ ì‹¤í–‰ë©ë‹ˆë‹¤.
- `Task`ëŠ” ëœë¤ ìˆœì„œëŒ€ë¡œ ì‹¤í–‰ ì™„ë£Œë©ë‹ˆë‹¤.

### @Sendable

- ê·¸ëŸ°ë° ì´ ì½”ë“œì—ì„œëŠ” ë¬¸ì œì ì´ ë°œìƒí•©ë‹ˆë‹¤. 
ì—¬ëŸ¬ `Task`ì—ì„œ `thumbnails` ìˆ˜ì •í•˜ë ¤ê³  í•˜ê¸° ë•Œë¬¸ì—, data raceê°€ ë°œìƒí•©ë‹ˆë‹¤â€¼ï¸
- `Task` ì´ì „ì—ëŠ” ì´ëŸ° ì½”ë“œê°€ ìˆë”ë¼ë„ ë¹Œë“œê°€ ê°€ëŠ¥í–ˆì§€ë§Œ, `Task` ë¥¼ ì‚¬ìš©í•˜ë©´ ì»´íŒŒì¼ íƒ€ì„ì— data raceê°€ ë°œìƒí•˜ëŠ” ì½”ë“œì¸ì§€ ì•„ë‹Œì§€ ì²´í¬í•´ì„œ ìš°ë¦¬ê°€ ì‚¬ì „ì— ì•Œ ìˆ˜ ìˆë„ë¡ ë§Œë“¤ì–´ì¤ë‹ˆë‹¤.
- ê·¸ë ‡ë‹¤ë©´, `Task` ì—ì„œ data raceë¥¼ ì–´ë–»ê²Œ íƒì§€í•˜ëŠ” ê²ƒì¼ê¹Œìš”?
    - `***@Sendable` í´ë¡œì € í™œìš©í•©ë‹ˆë‹¤â€¼ï¸***
    - Taskê°€ íŒŒë¼ë¯¸í„°ë¡œ ë°›ëŠ” í´ë¡œì €ëŠ” `@Sendable` í´ë¡œì €ì…ë‹ˆë‹¤.
    - `@Sendable` í´ë¡œì €ëŠ” ë‚´ë¶€ì—ì„œ mutable ë³€ìˆ˜ë¥¼ ìº¡ì²˜í•˜ì§€ ëª»í•˜ë„ë¡ í•©ë‹ˆë‹¤.
    - ë”°ë¼ì„œ `@Sendable` í´ë¡œì € ë‚´ë¶€ì—ì„œëŠ” value type (`Int`, `String` ë“±), `actor` , ë™ê¸°í™” ì²˜ë¦¬ëœ class ë§Œ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
    
- í•´ê²° ë°©ë²•

![á„‰á…³á„á…³á„…á…µá†«á„‰á…£á†º 2022-07-28 á„‹á…©á„’á…® 8.10.14.jpg](%5BWWDC%202022%5D%20Explore%20structured%20concurrency%20in%20Swif%20272879ee2f8a4529b1d34ddd132b2bb0/%25E1%2584%2589%25E1%2585%25B3%25E1%2584%258F%25E1%2585%25B3%25E1%2584%2585%25E1%2585%25B5%25E1%2586%25AB%25E1%2584%2589%25E1%2585%25A3%25E1%2586%25BA_2022-07-28_%25E1%2584%258B%25E1%2585%25A9%25E1%2584%2592%25E1%2585%25AE_8.10.14.jpg)

- `Task` ì—ì„œëŠ” `id`ì™€ `fetchOneThumbnail(withId:)` ê²°ê³¼ë¥¼ tupleë¡œ ë¦¬í„´í•©ë‹ˆë‹¤.
- ê·¸ë¦¬ê³  `for await loop` ì„ ì´ìš©í•´ì„œ ê²°ê³¼ê°’ì„ ê°€ì ¸ì™€ì„œ `thumbnails` ë”•ì…”ë„ˆë¦¬ì— ì €ì¥í•©ë‹ˆë‹¤.
    - `for await loop` ì€ ì‘ì—…ì´ ì™„ë£Œëœ Task ìˆœì„œëŒ€ë¡œ í•œë²ˆì— í•˜ë‚˜ì˜ ê²°ê³¼ê°’ì„ ê°€ì ¸ì™€ì„œ ì²˜ë¦¬í•˜ê¸° ë•Œë¬¸ì—, `thumbnails`ì— ë™ì‹œì— ì ‘ê·¼í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
    

> ***ì´ë ‡ë“¯ ë¶€ëª¨-ìì‹ ê´€ê³„ë¥¼ ëª…í™•í•˜ê²Œ ì´ë£¨ë©´ì„œ ìƒì„±ë˜ëŠ” Taskë¥¼ Structured Taskë¼ê³  í•©ë‹ˆë‹¤!***
> 

structured Taskê°€ ì¡´ì¬í•˜ë“ , unstructrued Taskë„ ì¡´ì¬í•©ë‹ˆë‹¤.!

## Unstructured Task

---

- unstructured Taskê°€ í•„ìš”í•œ ë•Œ
1. `non async`ë©”ì„œë“œì—ì„œ `async` ì½”ë“œë¥¼ ì‹¤í–‰í•´ì•¼ í•  ë•Œ 
(some tasks need to launch from non-async contexts)
2. `Task` ê°€ í•œì •ëœ ë²”ìœ„ì—ì„œë§Œ ì‹¤í–‰ë˜ëŠ” ê²ƒì´ ì•„ë‹ˆë¼, ë” ì˜¤ë«ë™ì•ˆ ì‹¤í–‰ë˜ë„ë¡ í•˜ê³  ì‹¶ì„ ë•Œ 
(some tasks live beyond the confines of a single scope)

- íŠ¹ì§•
1. ìì‹ ì„ ìƒì„±í•œ Taskì˜ ì‹¤í–‰ ìš°ì„ ìˆœìœ„ì™€ ì‹¤í–‰ actorë¥¼ ìƒì†ë°›ìŠµë‹ˆë‹¤.
    
    Inherit actor isolation and priority of the origin context)
    
2. ìƒëª…ì£¼ê¸°ê°€ íŠ¹ì • ë²”ìœ„ë¡œ ì œí•œë˜ì§€ ì•ŠìŠµë‹ˆë‹¤. 
(ìì‹ ì´ ìƒì„±ëœ ìœ„ì¹˜ì˜ scopeê°€ ì¢…ë£Œë˜ë”ë¼ë„, ê³„ì†í•´ì„œ ì‹¤í–‰ë©ë‹ˆë‹¤.)
    
    Lifetime is not confined to any scope
    
3. async-await ë©”ì„œë“œê°€ ì•„ë‹ˆë”ë¼ë„ ìƒì„±ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
    
    Can be launched anywhere, even non-async functions
    
4. ì‘ì—…ì„ ì·¨ì†Œ(cancelled)í•˜ëŠ” ì‘ì—…, ì‘ì—…ì´ ì™„ë£Œë  ë•Œê¹Œì§€ ëŒ€ê¸°í•˜ëŠ” ì‘ì—…(awaited)ì€ ìˆ˜ë™ìœ¼ë¡œ êµ¬í˜„í•´ì•¼ í•©ë‹ˆë‹¤.
Must be manually cancelled or awaited

- ì‚¬ìš© ì˜ˆì‹œ

![á„‰á…³á„á…³á„…á…µá†«á„‰á…£á†º 2022-07-28 á„‹á…©á„’á…® 8.19.13.jpg](%5BWWDC%202022%5D%20Explore%20structured%20concurrency%20in%20Swif%20272879ee2f8a4529b1d34ddd132b2bb0/%25E1%2584%2589%25E1%2585%25B3%25E1%2584%258F%25E1%2585%25B3%25E1%2584%2585%25E1%2585%25B5%25E1%2586%25AB%25E1%2584%2589%25E1%2585%25A3%25E1%2586%25BA_2022-07-28_%25E1%2584%258B%25E1%2585%25A9%25E1%2584%2592%25E1%2585%25AE_8.19.13.jpg)

- collection viewì—ì„œ ë³´ì—¬ì¤„ ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¤ê¸° ìœ„í•´ì„œ delegateë©”ì„œë“œì—ì„œ `fetchThumbnails()` ë¼ëŠ” `async-await` ë©”ì„œë“œë¥¼ í˜¸ì¶œí•˜ê³  ì‹¶ì§€ë§Œ, delegate ë©”ì„œë“œëŠ” `async-await` ë©”ì„œë“œê°€ ì•„ë‹ˆë¼ì„œ í˜¸ì¶œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.
- ì´ë ‡ë“¯, `async-await` ë©”ì„œë“œê°€ ì•„ë‹Œ ê³³ì—ì„œ `async-await` ë©”ì„œë“œë¥¼ í˜¸ì¶œí•˜ê³  ì‹¶ì„ ë•Œ `Unstructured Task`ë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤.

![á„‰á…³á„á…³á„…á…µá†«á„‰á…£á†º 2022-07-28 á„‹á…©á„’á…® 8.22.08.jpg](%5BWWDC%202022%5D%20Explore%20structured%20concurrency%20in%20Swif%20272879ee2f8a4529b1d34ddd132b2bb0/%25E1%2584%2589%25E1%2585%25B3%25E1%2584%258F%25E1%2585%25B3%25E1%2584%2585%25E1%2585%25B5%25E1%2586%25AB%25E1%2584%2589%25E1%2585%25A3%25E1%2586%25BA_2022-07-28_%25E1%2584%258B%25E1%2585%25A9%25E1%2584%2592%25E1%2585%25AE_8.22.08.jpg)

- `Task`ë¥¼ í•˜ë‚˜ ìƒì„±í•˜ê³ , ë‚´ë¶€ì—ì„œ async-await ë©”ì„œë“œë¥¼ í˜¸ì¶œí•˜ë©´ ë©ë‹ˆë‹¤.
- ì½”ë“œê°€ ì‹¤í–‰ë˜ë‹¤ê°€ `Task` ë¥¼ ìƒì„±í•˜ëŠ” ì½”ë“œë¥¼ ë§Œë‚˜ë©´, Taskê°€ ìƒì„±ë©ë‹ˆë‹¤.  
ê·¸ë¦¬ê³  SwiftëŠ” ìƒì„±ëœ `Task` ê°€ í˜„ì¬ ì½”ë“œë¥¼ ì‹¤í–‰í•˜ëŠ” `actor`(ìš°ì„ , ìŠ¤ë ˆë“œë¼ê³  ìƒê°í•˜ë©´ ì‰½ë‹¤.)ì™€ ë™ì¼í•œ `actor` ì—ì„œ ì‹¤í–‰ë˜ë„ë¡ ìŠ¤ì¼€ì¤„ë§í•©ë‹ˆë‹¤.
- ì—¬ê¸°ì„œëŠ” ìƒˆë¡œìš´ Main Threadì— ìŠ¤ì¼€ì¤„ë§í•©ë‹ˆë‹¤.

- Task ì·¨ì†Œ ì˜ˆì‹œ

```swift
@MainActor
class MyDelegate: UICollectionViewDelegate {
  var thumbnailTasks: [IndexPath: Task<Void, Never>] = [:]
  
  func collectionView(_ view: UICollectionView, willDisplay cell: UICollectionViewCell, forItemAt item: IndexPath) {
    let ids = getThumbnailIDs(for: item)
    thumbnailTasks[item] = Task { // ğŸ‘ˆğŸ» create and store unstructured tasks
      defer { thumbnailTasks[item] = nil } // ğŸ‘ˆğŸ» we remove the task when it's finished, so we don't cancel it when it's finished already
      let thumbnails = await fetchThumbnails(for: ids)
      display(thumbnails, in: cell)
    }
  }
  
  func collectionView(_ view: UICollectionView, didEndDisplay cell: UICollectionViewCell, forItemAt item: IndexPath) {
    thumbnailTasks[item]?.cancel() // ğŸ‘ˆğŸ» we cancel said task when that cell is no longer displayed
  }
}
```

- ìœ„ ì½”ë“œëŠ” collection view cellì—ì„œ ë³´ì—¬ì¤„ ë°ì´í„°ë¥¼ ë‹¤ìš´ë¡œë“œ ë°›ëŠ” ì‘ì—…ì„ ì‹œì‘í–ˆë”ë¼ë„, 
ë‹¤ìš´ë¡œë“œê°€ ì™„ë£Œë˜ê¸° ì „ì— cellì´ ë·°ì—ì„œ ì‚¬ë¼ì§„ ê²½ìš°ì—ëŠ” ì‘ì—…ì„ ì·¨ì†Œí•˜ë„ë¡ êµ¬í˜„í•œ ê²ƒì…ë‹ˆë‹¤.

1. `thumbnailsTasks` ë”•ì…”ë„ˆë¦¬ì— Unstructured Taskë¥¼ ì €ì¥í•´ë‘¡ë‹ˆë‹¤.
2. Taskì—ì„œ `defer` ëŠ” ì‘ì—…ì„ ì™„ë£Œí•œ í›„ì— ì‹¤í–‰ë˜ëŠ” ì½”ë“œì…ë‹ˆë‹¤. 
ì—¬ê¸°ì„œ `defer` ëŠ” ì‘ì—…ì´ ëë‚œ TaskëŠ” `thumbnailsTasks`ë”•ì…”ë„ˆë¦¬ì—ì„œ ì‚­ì œë˜ë„ë¡ ë§Œë“­ë‹ˆë‹¤.
3. ë§Œì¼, cellì´ í™”ë©´ì—ì„œ ì‚¬ë¼ì¡Œì„ ë•Œ `thumbnailsTasks` ë”•ì…”ë„ˆë¦¬ì— Taskê°€ ë‚¨ì•„ìˆë‹¤ë©´, ì•„ì§ Taskê°€ ì‹¤í–‰ì¤‘ì´ë¼ëŠ” ì˜ë¯¸ì´ê¸° ë•Œë¬¸ì— `cancel()`ì„ í˜¸ì¶œí•´ì„œ ì‘ì—…ì„ ì·¨ì†Œí•©ë‹ˆë‹¤.

## Detached Task

---

- unstrcutred taskì™€ ë‹¬ë¦¬, ìì‹ ì„ ìƒì„±í•œ ì‹¤í–‰ context(ë¶€ëª¨ Task)ë¡œ ë¶€í„° ì•„ë¬´ê²ƒë„ ìƒì†ë°›ì§€ ì•ŠìŠµë‹ˆë‹¤.
    
    (Unstructured tasks inherit traits from that taskâ€™s originating context, detached tasks don't.)
    
- unstrcutred taskì™€ ë§ˆì°¬ê°€ì§€ë¡œ, ìì‹ ì´ ìƒì„±ëœ scopeë³´ë‹¤ ë” ì˜¤ë«ë™ì•ˆ ì‹¤í–‰ë˜ê³ , 
ì·¨ì†Œ ì‘ì—…ì™€ ì™„ë£Œ ëŒ€ê¸° ì‘ì—…ì€ ìˆ˜ë™ìœ¼ë¡œ í•´ì•¼í•©ë‹ˆë‹¤.
    
    (Unscoped lifetime, manually cancelled and awaited)
    
- ì‹¤í–‰ ìš°ì„ ìˆœìœ„ëŠ” default ê°’ì„ ê°–ì§€ë§Œ, 
ìƒì„±í•  ë•Œ íŒŒë¼ë¯¸í„°ë¥¼ í†µí•´ì„œ ì–´ë””ì„œ, ì–´ë–»ê²Œ ì‹¤í–‰ë ì§€ë¥¼ ì§€ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

- ì˜ˆì‹œ ì½”ë“œ

![Untitled](%5BWWDC%202022%5D%20Explore%20structured%20concurrency%20in%20Swif%20272879ee2f8a4529b1d34ddd132b2bb0/Untitled.jpeg)

- detched Task ë‚´ë¶€ì—ì„œ group taskë¥¼ ìƒì„±í•´ì„œ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

![á„‰á…³á„á…³á„…á…µá†«á„‰á…£á†º 2022-07-28 á„‹á…©á„’á…® 8.51.04.jpg](%5BWWDC%202022%5D%20Explore%20structured%20concurrency%20in%20Swif%20272879ee2f8a4529b1d34ddd132b2bb0/%25E1%2584%2589%25E1%2585%25B3%25E1%2584%258F%25E1%2585%25B3%25E1%2584%2585%25E1%2585%25B5%25E1%2586%25AB%25E1%2584%2589%25E1%2585%25A3%25E1%2586%25BA_2022-07-28_%25E1%2584%258B%25E1%2585%25A9%25E1%2584%2592%25E1%2585%25AE_8.51.04.jpg)

## ì •ë¦¬

---

![á„‰á…³á„á…³á„…á…µá†«á„‰á…£á†º 2022-07-28 á„‹á…©á„’á…® 8.54.35.jpg](%5BWWDC%202022%5D%20Explore%20structured%20concurrency%20in%20Swif%20272879ee2f8a4529b1d34ddd132b2bb0/%25E1%2584%2589%25E1%2585%25B3%25E1%2584%258F%25E1%2585%25B3%25E1%2584%2585%25E1%2585%25B5%25E1%2586%25AB%25E1%2584%2589%25E1%2585%25A3%25E1%2586%25BA_2022-07-28_%25E1%2584%258B%25E1%2585%25A9%25E1%2584%2592%25E1%2585%25AE_8.54.35.jpg)

## Structured Concurrency ë€â“

---

- [ìœ„í‚¤í”¼ë””ì•„](https://en.wikipedia.org/wiki/Structured_concurrency)ì— ë”°ë¥´ë©´ concurrent ì½”ë“œë¥¼ ìº¡ìŠí™”í•´ì„œ, concurrent ì½”ë“œë¥¼ ëª…í™•í•˜ê³ (clarity), ì¢‹ì€ í’ˆì§ˆ(quality)ì˜ ì½”ë“œë¡œ ë¹ ë¥´ê²Œ ê°œë°œí•˜ëŠ” í”„ë¡œê·¸ë˜ë° íŒ¨ëŸ¬ë‹¤ì„
- howâ“
    
    concurrency programmingì—ì„œ  â€œscope ë‚´ì—ì„œ ìƒì„±ëœ ì‹¤í–‰ contextëŠ”, scopeê°€ ì¢…ë£Œë˜ê¸° ì „ì— ì „ë¶€ ì‹¤í–‰ì™„ë£Œ ë˜ì–´ì•¼ í•œë‹¤.â€ ì›ì¹™ì„ ì§€í‚¨ë‹¤.
    
- ì¥ì 
    - ìœ„ì˜ ì›ì¹™ ë•ë¶„ì— í”„ë¡œê·¸ë˜ë¨¸ëŠ” concurrency programmingì„ í•  ë•Œ ë‹¤ìŒê³¼ ê°™ì€ ì¥ì ì„ ëˆ„ë¦´ ìˆ˜ ìˆë‹¤.
    1. error handlingì„ í”„ë¡œê·¸ë˜ë° ì–¸ì–´ì—ì„œ ì œê³µí•˜ëŠ” ê¸°ëŠ¥ (throw - catch)ë¥¼ ì´ìš©í•´ì„œ í•  ìˆ˜ ìˆë‹¤.
    2. ì‹¤í–‰ context ê°„ì— ë¶€ëª¨-ìì‹ ê´€ê³„ê°€ ì¡´ì¬í•˜ëŠ”ë°, ìì‹ ì‹¤í–‰ contextì—ì„œ ë°œìƒí•œ errorëŠ” ë¶€ëª¨, í˜•ì œ ì‹¤í–‰ contextë¡œ ì „íŒŒëœë‹¤.
    3. ë³‘ë ¬ì„±/ë™ì‹œì„± í”„ë¡œê·¸ë˜ë°ì„ í•˜ë©´, í”„ë¡œê·¸ë¨ì˜ íë¦„ì„ íŒŒì•…í•˜ê¸° ì–´ë µì§€ë§Œ, 
    structured concurrencyì—ì„œëŠ” ì‹¤í–‰ íë¦„ì„ ëª…í™•í•˜ê²Œ íŒŒì•…í•  ìˆ˜ ìˆë‹¤.
    

## Q&A

---

### ì•„ë˜ ì‚¬ì§„ì—ì„œ `cannot use error handling`, `cannot use loop` ê°€ ë¬´ìŠ¨ ì˜ë¯¸?

![á„‰á…³á„á…³á„…á…µá†«á„‰á…£á†º 2022-07-28 á„‹á…©á„’á…® 10.05.31.jpg](%5BWWDC%202022%5D%20Explore%20structured%20concurrency%20in%20Swif%20272879ee2f8a4529b1d34ddd132b2bb0/%25E1%2584%2589%25E1%2585%25B3%25E1%2584%258F%25E1%2585%25B3%25E1%2584%2585%25E1%2585%25B5%25E1%2586%25AB%25E1%2584%2589%25E1%2585%25A3%25E1%2586%25BA_2022-07-28_%25E1%2584%258B%25E1%2585%25A9%25E1%2584%2592%25E1%2585%25AE_10.05.31.jpg)

- `cannot use error handling`:
    
    `escaping closure`ì—ì„œëŠ” errorë¥¼ `throw` í•˜ì§€ ëª»í•œë‹¤.
    
- `cannot use loop` :
    
    ìœ„ ì½”ë“œì—ì„œ `prepareThumbnail()`ì˜ ê²°ê³¼ê°’ì„ ê°€ì§€ê³  `fetchThumbnails()`ë¥¼ ë°˜ë³µí•´ì„œ í˜¸ì¶œí•˜ê³  ì‹¶ì–´ë„, `completion handler`ë¡œ ì¸í•´ `for loop`ì„ ì‚¬ìš©í•˜ì§€ ëª»í•˜ê³ , ì¬ê·€í˜¸ì¶œì„ ì‚¬ìš©í•´ì•¼ í•œë‹¤.
